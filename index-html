<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Michelle AI Ultimate</title>
    
    <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.145.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root { --accent: #00ffcc; --bg: #050505; }
        body { margin: 0; background: var(--bg); color: white; font-family: sans-serif; overflow: hidden; height: 100vh; }
        #canvas-container { width: 100%; height: 70vh; background: radial-gradient(circle, #222 0%, #050505 100%); }
        .ui-panel {
            height: 30vh; background: rgba(15, 15, 15, 0.95); border-top: 2px solid var(--accent);
            padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; overflow-y: auto;
        }
        .status-box { grid-column: span 2; text-align: center; font-size: 0.7rem; color: var(--accent); background: rgba(0,0,0,0.5); padding: 4px; border-radius: 4px; }
        button { padding: 12px; background: #222; color: white; border: 1px solid #444; border-radius: 8px; font-weight: bold; font-size: 0.8rem; }
        button:active { background: var(--accent); color: black; }
        .btn-main { background: linear-gradient(45deg, #00ffcc, #0099ff); color: black; border: none; }
        input[type="text"] { grid-column: span 2; padding: 10px; background: #111; border: 1px solid var(--accent); color: white; border-radius: 8px; }
        #ui-toggle { position: absolute; top: 10px; right: 10px; z-index: 100; opacity: 0.6; padding: 5px; font-size: 0.6rem; }
    </style>
</head>
<body>

    <button id="ui-toggle" onclick="toggleUI()">HIDE UI</button>
    <div id="canvas-container"></div>

    <div class="ui-panel" id="main-panel">
        <div class="status-box" id="status">Sistem Siap. Menunggu Input...</div>
        
        <input type="text" id="chatInput" placeholder="Ketik pesan untuk Michelle..." onkeypress="if(event.key === 'Enter') chatWithAI()">
        
        <button class="btn-main" onclick="chatWithAI()">ğŸ’¬ Kirim Pesan</button>
        <button onclick="playPose('dance')">ğŸ’ƒ Dance</button>
        <button onclick="manualStrip()" style="color: #ff00ff;">ğŸ”“ X-Ray Mode</button>
        <button onclick="playPose('kiss')">ğŸ’‹ Kiss</button>
        
        <div style="grid-column: span 2; display: flex; gap: 5px;">
            <button style="flex: 1;" onclick="document.getElementById('fileInput').click()">ğŸ“‚ Load .GLB</button>
            <button style="flex: 1;" onclick="resetApp()">ğŸ—‘ï¸ Reset</button>
        </div>

        <input type="file" id="fileInput" accept=".glb,.gltf" style="display: none;" onchange="handleFileSelect(event)">
    </div>

    <script>
        let scene, camera, renderer, model, mixer, controls, clock = new THREE.Clock();
        let isSpeaking = false;
        const statusText = document.getElementById('status');

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.7), 0.1, 1000);
            camera.position.set(0, 1.4, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            const light = new THREE.AmbientLight(0xffffff, 1);
            scene.add(light);
            const spot = new THREE.PointLight(0xffffff, 1);
            spot.position.set(5, 5, 5);
            scene.add(spot);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.target.set(0, 1, 0);

            // Default Model (Ganti dengan link Michelle-mu jika sudah ada)
            loadModel('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/Michelle.glb');

            window.addEventListener('resize', onWindowResize);
            animate();
        }

        function loadModel(url) {
            statusText.innerText = "Memuat Model...";
            const loader = new THREE.GLTFLoader();
            loader.load(url, (gltf) => {
                if(model) scene.remove(model);
                model = gltf.scene;
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);
                
                // Audit Material: Glow & Realistic Skin
                model.traverse(n => {
                    if (n.isMesh) {
                        n.material.roughness = 0.4;
                        n.material.metalness = 0.1;
                    }
                });
                statusText.innerText = "Michelle Aktif & Glowing";
            }, undefined, (e) => { statusText.innerText = "Gagal memuat model."; });
        }

        async function chatWithAI() {
            const input = document.getElementById('chatInput');
            const msg = input.value;
            if(!msg) return;
            
            statusText.innerText = "Michelle berpikir...";
            // Simulasi Otak (Hubungkan ke API Gemini di sini)
            const response = "Aku mendengarmu. Kamu bilang: " + msg; 
            
            speak(response);
            input.value = "";
            statusText.innerText = "Michelle: " + response;
        }

        function speak(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.lang = 'id-ID';
            u.onstart = () => { isSpeaking = true; };
            u.onend = () => { isSpeaking = false; };
            window.speechSynthesis.speak(u);
        }

        function manualStrip() {
            if(!model) return;
            model.traverse(n => {
                if(n.isMesh && (n.name.toLowerCase().includes('cloth') || n.name.toLowerCase().includes('outfit'))) {
                    n.visible = !n.visible;
                }
            });
            speak("Apakah seperti ini lebih baik?");
        }

        function playPose(type) {
            if(type === 'kiss') { camera.position.set(0, 1.5, 0.7); speak("Muach!"); }
            if(type === 'dance') { statusText.innerText = "Dance Mode!"; }
        }

        function toggleUI() {
            const p = document.getElementById('main-panel');
            p.style.display = p.style.display === 'none' ? 'grid' : 'none';
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / (window.innerHeight * 0.7);
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(mixer) mixer.update(clock.getDelta());
            if(isSpeaking && model) {
                // Lip Sync Sederhana
                model.traverse(n => {
                    if(n.morphTargetInfluences) n.morphTargetInfluences[0] = Math.random() * 0.2;
                });
            }
            renderer.render(scene, camera);
        }

        function resetApp() { location.reload(); }
        function handleFileSelect(e) {
            const reader = new FileReader();
            reader.onload = (ev) => loadModel(URL.createObjectURL(new Blob([ev.target.result])));
            reader.readAsArrayBuffer(e.target.files[0]);
        }

        init();
    </script>
</body>
</html>
