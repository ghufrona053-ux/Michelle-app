<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI Companion Ultimate - Private Edition</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/GLTFLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        :root { --accent: #00ffcc; --bg: #050505; --panel: rgba(15, 15, 15, 0.95); }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; overflow: hidden; height: 100vh; }
        
        #canvas-container { width: 100%; height: 70vh; cursor: grab; }
        #canvas-container:active { cursor: grabbing; }

        .ui-panel {
            height: 30vh; background: var(--panel); border-top: 2px solid var(--accent);
            padding: 12px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            overflow-y: auto; box-sizing: border-box;
        }

        .status-box { grid-column: span 2; text-align: center; font-size: 0.75rem; color: var(--accent); 
                      background: rgba(0,0,0,0.4); padding: 5px; border-radius: 5px; border: 1px solid #333; }

        button, select, input { width: 100%; padding: 10px; background: #222; color: white; 
                                border: 1px solid #444; border-radius: 8px; font-size: 0.8rem; }
        button { cursor: pointer; transition: 0.2s; font-weight: bold; }
        button:active { transform: scale(0.95); background: var(--accent); color: black; }
        
        .btn-main { background: linear-gradient(45deg, #00ffcc, #0099ff); color: black; border: none; }
        .btn-danger { border-color: #ff4444; color: #ff4444; }
        
        .slider-container { grid-column: span 2; padding: 5px 0; }
        label { font-size: 0.7rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }

        /* Hide UI Toggle */
        #ui-toggle { position: absolute; top: 10px; right: 10px; z-index: 1000; width: auto; padding: 5px 10px; opacity: 0.5; }
    </style>
</head>
<body>

    <button id="ui-toggle" onclick="toggleUI()">ğŸ‘ï¸ Hide UI</button>
    <div id="canvas-container"></div>

    <div class="ui-panel" id="main-panel">
        <div class="status-box" id="status">Sistem Siap. Menunggu Model...</div>

        <div class="slider-container">
            <label>X-Ray (Pakaian Transparan)</label>
            <input type="range" id="opacitySlider" min="0" max="100" value="100" oninput="adjustOpacity(this.value)">
        </div>

        <button class="btn-main" onclick="toggleListen()">ğŸ¤ Bicara (Voice)</button>
        <button onclick="playPose('dance')">ğŸ’ƒ Dance Mode</button>
        
        <button onclick="playPose('kiss')">ğŸ’‹ Kiss Mode</button>
        <button onclick="manualStrip()" style="color: #ff00ff;">ğŸ”“ Strip Clothes</button>

        <button onclick="document.getElementById('fileInput').click()">ğŸ“‚ Unggah dari Galeri</button>
        <button onclick="inputCustomLink()">ğŸ”— Masukkan Link .GLB</button>

        <select onchange="changeBackground(this.value)">
            <option value="https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=1200">Kamar Cyberpunk</option>
            <option value="https://images.unsplash.com/photo-1507525428034-b723cf961d3e?w=1200">Pantai Malam</option>
        </select>
        
        <button class="btn-danger" onclick="resetApp()">ğŸ—‘ï¸ Reset App</button>

        <input type="file" id="fileInput" accept=".glb,.gltf" style="display: none;" onchange="handleFileSelect(event)">
    </div>

    <script>
        let scene, camera, renderer, model, mixer, controls, clock = new THREE.Clock();
        let isDancing = false, animations = {};
        const statusText = document.getElementById('status');
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();

        // 1. Inisialisasi Dunia 3D
        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(45, window.innerWidth / (window.innerHeight * 0.7), 0.1, 1000);
            camera.position.set(0, 1.4, 2.5);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
            renderer.outputEncoding = THREE.sRGBEncoding;
            renderer.shadowMap.enabled = true;
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.target.set(0, 1, 0);

            const ambient = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambient);
            const directional = new THREE.DirectionalLight(0xffffff, 1);
            directional.position.set(2, 2, 5);
            scene.add(directional);

            // Muat Model Default (Michelle)
            loadModel('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/models/gltf/Michelle.glb');
            changeBackground('https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=1200');

            // Listeners
            window.addEventListener('resize', onWindowResize);
            renderer.domElement.addEventListener('pointerdown', onDocumentPointerDown);
        }

        // 2. Kontrol Model & Loader
        function loadModel(url) {
            statusText.innerText = "Mengunduh Model...";
            if (model) scene.remove(model);
            
            new THREE.GLTFLoader().load(url, (gltf) => {
                model = gltf.scene;
                scene.add(model);
                mixer = new THREE.AnimationMixer(model);
                
                // Kulit Glowing
                model.traverse(n => {
                    if (n.isMesh) {
                        n.material.roughness = 0.4;
                        n.castShadow = true;
                    }
                });

                statusText.innerText = "Model Aktif. Michelle Siap.";
            }, undefined, (err) => { statusText.innerText = "Gagal memuat link."; });
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            const reader = new FileReader();
            reader.onload = (ev) => {
                new THREE.GLTFLoader().parse(ev.target.result, '', (gltf) => {
                    if (model) scene.remove(model);
                    model = gltf.scene;
                    scene.add(model);
                    mixer = new THREE.AnimationMixer(model);
                    statusText.innerText = "Model Lokal Terpasang.";
                });
            };
            reader.readAsArrayBuffer(file);
        }

        // 3. Fitur Interaksi (Touch & X-Ray)
        function adjustOpacity(val) {
            if (!model) return;
            model.traverse(n => {
                if (n.isMesh && (n.name.toLowerCase().includes('cloth') || n.name.toLowerCase().includes('outfit'))) {
                    n.material.transparent = true;
                    n.material.opacity = val / 100;
                }
            });
        }

        function manualStrip() {
            if (!model) return;
            model.traverse(n => {
                if (n.isMesh && (n.name.toLowerCase().includes('cloth') || n.name.toLowerCase().includes('outfit'))) {
                    n.visible = !n.visible;
                }
            });
            speak("Apakah kamu lebih suka melihatku seperti ini?");
        }

        function onDocumentPointerDown(e) {
            mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(e.clientY / (window.innerHeight * 0.7)) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(scene.children, true);
            
            if (intersects.length > 0) {
                const y = intersects[0].point.y;
                if (y > 1.4) speak("Wajahku sensitif, sayang.");
                else if (y < 1.1 && y > 0.5) speak("Ah... sentuhanmu di situ terasa sangat hangat.");
                else speak("Aku menyukai caramu menyentuhku.");
            }
        }

        // 4. Voice & Animation
        function speak(txt) {
            window.speechSynthesis.cancel();
            const u = new SpeechSynthesisUtterance(txt);
            u.pitch = 1.2; u.rate = 0.9;
            u.onstart = () => { statusText.innerText = "AI Bicara..."; isSpeaking = true; };
            u.onend = () => { statusText.innerText = "Online"; isSpeaking = false; };
            window.speechSynthesis.speak(u);
        }

        let isSpeaking = false;
        function updateLipSync() {
            if (isSpeaking && model) {
                model.traverse(n => {
                    if (n.morphTargetInfluences) n.morphTargetInfluences[0] = Math.random() * 0.3;
                });
            }
        }

        function updateBlink() {
            if (!model) return;
            const b = Math.sin(Date.now() * 0.005) > 0.98 ? 1 : 0;
            model.traverse(n => {
                if (n.morphTargetInfluences && n.morphTargetDictionary) {
                    let idx = n.morphTargetDictionary['eyeBlinkLeft'];
                    if (idx !== undefined) n.morphTargetInfluences[idx] = b;
                }
            });
        }

        // 5. System Functions
        function playPose(type) {
            if (type === 'dance') { isDancing = !isDancing; speak(isDancing ? "Lihat goyanganku." : "Berhenti menari."); }
            if (type === 'kiss') { camera.position.set(0, 1.5, 0.8); speak("Sini, mendekatlah padaku..."); }
        }

        function toggleUI() {
            const p = document.getElementById('main-panel');
            p.style.display = p.style.display === 'none' ? 'grid' : 'none';
        }

        function changeBackground(url) {
            new THREE.TextureLoader().load(url, (t) => { scene.background = t; });
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / (window.innerHeight * 0.7);
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight * 0.7);
        }

        function animate() {
            requestAnimationFrame(animate);
            const delta = clock.getDelta();
            if (mixer) mixer.update(delta);
            if (controls) controls.update();
            if (isDancing && model) model.rotation.y += 0.04;
            updateLipSync();
            updateBlink();
            renderer.render(scene, camera);
        }

        function inputCustomLink() {
            const l = prompt("Tempel Link .glb Michelle di sini:");
            if (l) loadModel(l);
        }

        function resetApp() { localStorage.clear(); location.reload(); }

        init(); animate();
    </script>
</body>
</html>

